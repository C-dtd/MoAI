<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React Page with createRoot</title>
</head>
<body>
    <div id="root"></div>

    <!-- React와 ReactDOM을 CDN에서 로드 -->
    <script src="https://unpkg.com/react/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.development.js"></script>
    
    <!-- Babel을 사용하여 브라우저에서 JSX를 변환 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@toast-ui/react-calendar"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/@toast-ui/calendar/dist/toastui-calendar.min.css">
    <link rel="stylesheet" href="https://unpkg.com/tui-date-picker/dist/tui-date-picker.css">
    <link rel="stylesheet" href="https://unpkg.com/tui-time-picker/dist/tui-time-picker.css">

    <script>
        function uuid() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        
    </script>
    <!-- JSX로 React 컴포넌트 작성 및 createRoot 사용 -->
    <script type="text/babel">
        const { useRef, useEffect } = React;
        const { ReactCalendar } = tui;
        // React 컴포넌트 정의
        const App = () => {
            const calendarRef = useRef(null);
            
            useEffect(() => {
                const calendarInstance = calendarRef.current.getInstance();
                const userId = 'user_id'; // 실제로 로그인한 사용자로 대체

                const loadEvents = async () => {
                    try {
                        const response = await fetch(`/api/events/${userId}`);
                        if (response.ok) {
                            const events = await response.json();
                            //console.log('Loaded events:', events);
                            events.forEach((event) => {
                                const eventObj = {
                                    ...event,
                                    start: event.start_date,
                                    end: event.end_date,
                                    isAllday: event.isallday,
                                }
                                calendarInstance.createEvents([eventObj]);                                
                            });
            
                            //calendarInstance.createEvents(events);
                        } else {
                            console.log('Failed to load events from the server');
                        }
                    } catch (error) {
                        console.error('Error loading events:', error);
                    }
                };
        
                loadEvents();

                // 캘린더에 기본 일정 추가
                // calendarInstance.createEvents(initialSchedules);

                // 팝업에서 일정 생성하기 전에 호출되는 함수 & DB에 데이터 전송도 같이
                const handleBeforeCreateEvent = async (eventObj) => {
                    const newEvent = {
                        ...eventObj,
                        id: uuid(), // 고유 ID 생성
                        
                    };
                    console.log('create', newEvent);
                    // //console.log(dateParser(newEvent.start.d.d));
                    console.log(newEvent);
                    // calendarInstance.createEvents([newEvent]);

                    const response = await fetch('/api/events', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(newEvent),
                    });

                    if (response.ok) {
                        console.log('서버로 이벤트 보내는 거 성공적임');
                        // 캘린더에 이벤트를 추가
                        calendarInstance.createEvents([newEvent]);
                    } else {
                        console.log('Failed to send event to the server');
                    }
                };

                const handleBeforeUpdateEvent = async ({ event, changes }) => {
                    console.log('Updating event:', event);
                    console.log('Changes:', changes);
                
                    const updatedEvent = {
                        ...event,
                        ...changes,  // 기존 이벤트 객체에 변경된 부분만 덮어씌우기
                    };
                
                    try {
                        const response = await fetch(`/api/events/${event.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatedEvent),
                        });
                
                        if (response.ok) {
                            const updatedEventFromServer = await response.json();
                            console.log('Updated event from server:', updatedEventFromServer);
                
                            // 서버에서 받아온 데이터로 캘린더 이벤트 업데이트
                            calendarInstance.updateEvent(event.id, event.calendarId, changes);
                        } else {
                            console.log('Failed to update event on the server');
                        }
                    } catch (error) {
                        console.error('Error updating event:', error);
                    }
                };
                

                const handleBeforeDeleteEvent = async ({ id, calendarId }) => {
                    console.log('Deleting event:', id);
                
                    try {
                        // 서버로 삭제 요청 보내기
                        const response = await fetch(`/api/events/${id}`, {
                            method: 'DELETE',
                        });
                
                        if (response.ok) {
                            // 서버에서 삭제 성공 시 클라이언트의 캘린더에서 이벤트 삭제
                            console.log('Event deleted successfully from the server');
                            calendarInstance.deleteEvent(id, calendarId);
                        } else {
                            console.log('Failed to delete event from the server');
                        }
                    } catch (error) {
                        console.error('Error deleting event:', error);
                    }
                };

                calendarInstance.on('beforeCreateEvent', handleBeforeCreateEvent);
                calendarInstance.on('beforeUpdateEvent', handleBeforeUpdateEvent);
                calendarInstance.on('beforeDeleteEvent', handleBeforeDeleteEvent);
            }, []);

            const calendarOptions = {
                week: {
                    dayNames: ['월', '화', '수', '목', '금', '토', '일'], // 요일 이름을 한글로 설정
                    startDayOfWeek: 0, // 일요일을 시작으로 설정 (0=일요일, 1=월요일)
                    narrowWeekend: true, // 주말을 좁게 표시
                },
                month: {
                    dayNames: ['일', '월', '화', '수', '목', '금', '토'], // 월간 보기에서 요일 이름 설정
                },
                template: {
                    popupIsAllday() {
                        return '하루종일';
                    },
                }
            };
            return (
                <div className="App">
                    <h1>My Calendar</h1>
                    <ReactCalendar
                        ref={calendarRef}
                        height='500px'
                        view="month"
                        useFormPopup={true}  // 팝업을 사용하도록 설정
                        useDetailPopup={true}
                        week={calendarOptions.week}  // 주간 옵션 전달
                        month={calendarOptions.month} // 월간 옵션 전달
                        template={calendarOptions.template} // 템플릿 옵션 추가
                    />
                </div>
            );
        };

        // ReactDOM.createRoot 사용하여 렌더링
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);

        root.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>
        );
    </script>
</body>
</html>