<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat and Calendar Interface</title>
    <link rel="stylesheet" href="../main_css/main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/@toast-ui/calendar/dist/toastui-calendar.min.css">
    <link rel="stylesheet" href="https://unpkg.com/tui-date-picker/dist/tui-date-picker.css">
    <link rel="stylesheet" href="https://unpkg.com/tui-time-picker/dist/tui-time-picker.css">
</head>
<body>
<div style="display: flex;">
    <aside class="sidebar">
        <header class="sidebar-header">
            <div class="user-profile">
                <img class="user-avatar" src="https://via.placeholder.com/32x32" alt="User Avatar">
                <span class="user-name">사용자명</span>
            </div>
            <div class="actions">
                <div class="action-icon_setting">
                    <img src="../image/setting.png" alt="Setting Icon" />
                </div>
                <div class="action-icon_sidebar">
                    <img src="../image/sidebar.png" alt="Sidebar Icon" />
                </div>
            </div>
        </header>

        <div role="search" class="search-input">
            <!-- <img src="../image/reading_glasses.png" alt="reading_glasses Icon" /> -->
            <input type="search" placeholder="Search for chats...">
            <button class="search-btn">search</button>
        </div>
        
        <nav class="menu">
            <div class="menu-item active">
                <span class="menu-icon">
                    <img src="../image/chat_icon.png" alt="chating Icon" />
                </span>
                <span class="menu-label">채팅</span>
                <div class="badge">1</div>
            </div>
            <div class="menu-item">
                <span class="menu-icon">
                    <img src="../image/project.png" alt="project Icon" />
                </span>
                <span class="menu-label">프로젝트</span>
                <div class="badge">2</div>
            </div>
            <div class="menu-item">
                <span class="menu-icon">
                    <img src="../image/application.png" alt="application Icon" />
                </span>
                <span class="menu-label">어플리케이션</span>
                <div class="badge">3</div>
            </div>
            <div class="menu-item">
                <span class="menu-icon">
                    <img src="../image/quality_control.png" alt="quality_control Icon" />
                </span>
                <span class="menu-label">품목 관리</span>
                <div class="badge">4</div>
            </div>
        </nav>
        <div class="additional-content">
            <div class="additional-section"></div>
            <div class="placeholder"></div>
        </div>
    </aside>
    <main class="main-content">
        <section class="calendar">
            <div id="root"></div>
        </section>
        <section class="note-section">
            메모장
        </section>
        <section class="chat-section">
            채팅방
        </section>
    </main>
</div>

<!-- React와 ReactDOM을 CDN에서 로드 -->
<script src="https://unpkg.com/react/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom/umd/react-dom.development.js"></script>
<!-- Babel을 사용하여 브라우저에서 JSX를 변환 -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://unpkg.com/@toast-ui/react-calendar"></script>

<script>
    function uuid() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    function leftpad (str, len, ch) {
        str = String(str);
        var i = -1;
        if (!ch && ch !== 0) ch = '';
        len = len - str.length;
        while (++i < len) {
            str = ch + str;
        }
        return str;
    }
    function dateParser(str) {
        let date = new Date(str.toString());
        res = '';

        res += leftpad(date.getFullYear(), 4, 0) +'-';
        res += leftpad(date.getMonth()+1, 2, 0) +'-';
        res += leftpad(date.getDay(), 2, 0) +'T';
        res += leftpad(date.getHours(), 2, 0) +':';
        res += leftpad(date.getMinutes(), 2, 0) +":";
        res += leftpad(date.getSeconds(), 2, 0);

        return res;
    }
</script>
<!-- JSX로 React 컴포넌트 작성 및 createRoot 사용 -->
<script type="text/babel">
    const { useRef, useEffect,useState } = React;
    const { ReactCalendar } = tui;
    // React 컴포넌트 정의
    const App = () => {
        const calendarRef = useRef(null);
        const [currentMonth, setCurrentMonth] = useState('');

        useEffect(() => {
            const updateMonth = () => {
            if (calendarRef.current) {
                const calendarInstance = calendarRef.current.getInstance();
                const viewDate = calendarInstance.getDate();
                setCurrentMonth(`${viewDate.getFullYear()}년 ${viewDate.getMonth() + 1}월`);
            }
            };

            updateMonth();
            const calendarInstance = calendarRef.current.getInstance();
            const initialSchedules = [
                {
                    id: uuid(),
                    title: '전체일정 이벤트',
                    category: 'allday',
                    start: '2024-08-22T00:00:00',
                    end: '2024-08-22T23:59:59',
                    state: 'Free',
                    location: 'home',
                    isReadOnly: false,
                    color: 'red',
                    borderColor: 'blue',
                    backgroundColor: 'green'
                },
            ];
            // 캘린더에 기본 일정 추가
            calendarInstance.createEvents(initialSchedules);

            // 팝업에서 일정 생성하기 전에 호출되는 함수
            const handleBeforeCreateEvent = (eventObj) => {
                const newEvent = {
                    ...eventObj,
                    id: uuid(), // 고유 ID 생성
                };
                console.log('create', eventObj);
                console.log(dateParser(eventObj.start.d.d));
                calendarInstance.createEvents([newEvent]);
            };

            const handleBeforeUpdateEvent = ({ event, changes }) => {
                console.log('Updating event:', event);
                console.log('Changes:', changes);

                calendarInstance.updateEvent(event.id, event.calendarId, changes);
            };

            const handleBeforeDeleteEvent = ({ id, calendarId }) => {
                console.log('Deleting event:', id);
                calendarInstance.deleteEvent(id, calendarId);
            };

            calendarInstance.on('beforeCreateEvent', handleBeforeCreateEvent);
            calendarInstance.on('beforeUpdateEvent', handleBeforeUpdateEvent);
            calendarInstance.on('beforeDeleteEvent', handleBeforeDeleteEvent);
        }, []);

        const calendarOptions = {
            week: {
                dayNames: ['월', '화', '수', '목', '금', '토', '일'], // 요일 이름을 한글로 설정
                startDayOfWeek: 0, // 일요일을 시작으로 설정 (0=일요일, 1=월요일)
                narrowWeekend: true, // 주말을 좁게 표시
            },
            month: {
                dayNames: ['일', '월', '화', '수', '목', '금', '토'], // 월간 보기에서 요일 이름 설정
            },
            template: {
                popupIsAllday() {
                    return '하루종일';
                },
                locationPlaceholder() {
                    return '장소';
                },
                titlePlaceholder() {
                    return '일정 제목';
                },
                popupSave() {
                    return '일정 추가';
                },
                popupEdit() {
                    return '수정';
                },
                popupDelete(){
                    return '삭제';
                }
            }
        };

        const handleNext = () => {
            const calendarInstance = calendarRef.current.getInstance();
            calendarInstance.next();
            updateMonth();
        };

        const handlePrev = () => {
            const calendarInstance = calendarRef.current.getInstance();
            calendarInstance.prev();
            updateMonth();
        };

        const handleToday = () => {
            const calendarInstance = calendarRef.current.getInstance();
            calendarInstance.today();
            updateMonth();
        };

        const updateMonth = () => {
            if (calendarRef.current) {
            const calendarInstance = calendarRef.current.getInstance();
            const viewDate = calendarInstance.getDate();
            setCurrentMonth(`${viewDate.getFullYear()}년 ${viewDate.getMonth() + 1}월`);
            }
        };

        return (
            <div className="App">
                <h1 align="center">{currentMonth}</h1>
                <div className="controls">
                    <button className="control-button" onClick={handlePrev}>이전 달</button>
                    <button className="control-button" onClick={handleNext}>다음 달</button>
                    <button className="control-button" onClick={handleToday}>오늘</button>
                </div>
                <ReactCalendar
                    ref={calendarRef}
                    height='500px'
                    view="month"
                    useFormPopup={true}  // 팝업을 사용하도록 설정
                    useDetailPopup={true}
                    week={calendarOptions.week}  // 주간 옵션 전달
                    month={calendarOptions.month} // 월간 옵션 전달
                    template={calendarOptions.template} // 템플릿 옵션 추가
                />
            </div>
        );
    };

    // ReactDOM.createRoot 사용하여 렌더링
    const rootElement = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElement);

    root.render(
        <React.StrictMode>
            <App />
        </React.StrictMode>
    );
</script>
</body>
</html>
